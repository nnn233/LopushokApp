CREATE TABLE IF NOT EXISTS AgentType (
  ID INT NOT NULL GENERATED ALWAYS AS IDENTITY,
  Title VARCHAR(50)  NOT NULL,
  Image VARCHAR(100)  NULL,
  PRIMARY KEY (ID));
  
CREATE TABLE IF NOT EXISTS Supplier (
  ID INT NOT NULL GENERATED ALWAYS AS IDENTITY,
  Title VARCHAR(150)  NOT NULL,
  INN VARCHAR(12) NOT NULL,
  StartDate DATE NOT NULL,
  QualityRating INT NULL,
  SupplierType VARCHAR(20)  NULL,
  PRIMARY KEY (ID));

CREATE TABLE IF NOT EXISTS ProductType (
  ID INT NOT NULL GENERATED ALWAYS AS IDENTITY,
  Title VARCHAR(50)  NOT NULL,
  DefectedPercent DOUBLE PRECISION NOT NULL,
  PRIMARY KEY (ID));

CREATE TABLE IF NOT EXISTS Product (
  ID INT NOT NULL GENERATED ALWAYS AS IDENTITY,
  Title VARCHAR(100)  NOT NULL,
  ProductTypeID INT NULL,
  ArticleNumber VARCHAR(10)  NOT NULL,
  Description TEXT  NULL,
  Image VARCHAR(100)  NULL,
  ProductionPersonCount INT NULL,
  ProductionWorkshopNumber INT NULL,
  MinCostForAgent DECIMAL(10,2) NOT NULL,
  PRIMARY KEY (ID),
  CONSTRAINT FK_Product_ProductType
    FOREIGN KEY (ProductTypeID)
    REFERENCES ProductType (ID)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION);

CREATE TABLE IF NOT EXISTS MaterialSupplier (
  MaterialID INT NOT NULL,
  SupplierID INT NOT NULL,
  PRIMARY KEY (MaterialID, SupplierID),
  CONSTRAINT FK_MaterialSupplier_Supplier
    FOREIGN KEY (SupplierID)
    REFERENCES Supplier (ID)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION,
  CONSTRAINT FK_MaterialSupplier_Material
    FOREIGN KEY (MaterialID)
    REFERENCES Material (ID)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION);
	
CREATE TABLE IF NOT EXISTS MaterialType (
  ID INT NOT NULL GENERATED ALWAYS AS IDENTITY,
  Title VARCHAR(50)  NOT NULL,
  DefectedPercent DOUBLE PRECISION NOT NULL,
  PRIMARY KEY (ID));

CREATE TABLE IF NOT EXISTS Material (
  ID INT NOT NULL GENERATED ALWAYS AS IDENTITY,
  Title VARCHAR(100)  NOT NULL,
  CountInPack INT NOT NULL,
  Unit VARCHAR(10)  NOT NULL,
  CountInStock DOUBLE PRECISION NULL,
  MinCount DOUBLE PRECISION NOT NULL,
  Description TEXT  NULL,
  Cost DECIMAL(10,2) NOT NULL,
  Image VARCHAR(100)  NULL,
  MaterialTypeID INT NOT NULL,
  PRIMARY KEY (ID),
  CONSTRAINT FK_Material_MaterialType
    FOREIGN KEY (MaterialTypeID)
    REFERENCES MaterialType (ID)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION);

CREATE TABLE IF NOT EXISTS ProductMaterial (
  ProductID INT NOT NULL,
  MaterialID INT NOT NULL,
  Count DOUBLE PRECISION NULL,
  PRIMARY KEY (ProductID, MaterialID),
  CONSTRAINT FK_ProductMaterial_Material
    FOREIGN KEY (MaterialID)
    REFERENCES Material (ID)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION,
  CONSTRAINT FK_ProductMaterial_Product
    FOREIGN KEY (ProductID)
    REFERENCES Product (ID)
    ON DELETE CASCADE
    ON UPDATE NO ACTION);

CREATE TABLE IF NOT EXISTS ProductSale (
  ID INT NOT NULL GENERATED ALWAYS AS IDENTITY,
  AgentID INT NOT NULL,
  ProductID INT NOT NULL,
  SaleDate DATE NOT NULL,
  ProductCount INT NOT NULL,
  PRIMARY KEY (ID),
  CONSTRAINT FK_ProductSale_Agent
    FOREIGN KEY (AgentID)
    REFERENCES Agent (ID)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION,
  CONSTRAINT FK_ProductSale_Product
    FOREIGN KEY (ProductID)
    REFERENCES Product (ID)
    ON DELETE RESTRICT
    ON UPDATE NO ACTION);

CREATE TABLE IF NOT EXISTS Agent (
  ID INT NOT NULL GENERATED ALWAYS AS IDENTITY,
  Title VARCHAR(150)  NOT NULL,
  AgentTypeID INT NOT NULL,
  Address VARCHAR(300)  NULL,
  INN VARCHAR(12) NOT NULL,
  KPP VARCHAR(9) NULL,
  DirectorName VARCHAR(100)  NULL,
  Phone VARCHAR(20)  NOT NULL,
  Email VARCHAR(255)  NULL,
  Logo VARCHAR(100)  NULL,
  Priority INT NOT NULL,
  PRIMARY KEY (ID),
  CONSTRAINT FK_Agent_AgentType
    FOREIGN KEY (AgentTypeID)
    REFERENCES AgentType (ID)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION);

CREATE TABLE IF NOT EXISTS Shop (
  ID INT NOT NULL GENERATED ALWAYS AS IDENTITY,
  Title VARCHAR(150)  NOT NULL,
  Address VARCHAR(300)  NULL,
  AgentID INT NOT NULL,
  PRIMARY KEY (ID),
  CONSTRAINT FK_Shop_Agent
    FOREIGN KEY (AgentID)
    REFERENCES Agent (ID)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION);

CREATE TABLE IF NOT EXISTS MaterialCountHistory (
  ID INT NOT NULL GENERATED ALWAYS AS IDENTITY,
  MaterialID INT NOT NULL,
  ChangeDate TIMESTAMP(6) NOT NULL,
  CountValue DOUBLE PRECISION NOT NULL,
  PRIMARY KEY (ID),
  CONSTRAINT FK_MaterialCountHistory_Material
    FOREIGN KEY (MaterialID)
    REFERENCES Material (ID)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION);

CREATE TABLE IF NOT EXISTS ProductCostHistory (
  ID INT NOT NULL GENERATED ALWAYS AS IDENTITY,
  ProductID INT NOT NULL,
  ChangeDate TIMESTAMP(6) NOT NULL,
  CostValue DECIMAL(10,2) NOT NULL,
  PRIMARY KEY (ID),
  CONSTRAINT FK_ProductCostHistory_Product
    FOREIGN KEY (ProductID)
    REFERENCES Product (ID)
    ON DELETE CASCADE
    ON UPDATE NO ACTION);

CREATE TABLE IF NOT EXISTS AgentPriorityHistory (
  ID INT NOT NULL GENERATED ALWAYS AS IDENTITY,
  AgentID INT NOT NULL,
  ChangeDate TIMESTAMP(6) NOT NULL,
  PriorityValue INT NOT NULL,
  PRIMARY KEY (ID),
  CONSTRAINT FK_AgentPriorityHistory_Agent
    FOREIGN KEY (AgentID)
    REFERENCES Agent (ID)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION);

CREATE TABLE IF NOT EXISTS usergroup(
	ID INT PRIMARY KEY,
	title VARCHAR(50) NOT NULL
);

CREATE TABLE IF NOT EXISTS public.user(
	ID INT PRIMARY KEY GENERATED ALWAYS AS IDENTITY,
	login VARCHAR(50) NOT NULL,
	password VARCHAR(50) NOT NULL,
	user_group INT REFERENCES usergroup(id)
);

INSERT INTO usergroup VALUES(1, 'Администратор'),
(2, 'Менеджер');

INSERT INTO public.user(login, password, user_group) VALUES('123456', '123456', 1),
('654321', '654321', 2);

INSERT INTO materialtype(title, defectedpercent) VALUES('Рулон', 0.5),
('Пресс', 0.5),
('Нарезка', 0.5),
('Гранулы', 0.5);

INSERT INTO materialtype(title, defectedpercent) VALUES('Три слоя', 0.5),
('Два слоя', 0.5),
('Детская', 0.5),
('Один слой', 0.5),
('Супер мягкая', 0.5);